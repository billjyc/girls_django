{% extends "snh48/base.html" %}
{% load static %}
{% block title %}
    {{ member.name }} {{ member.team.name }}
{% endblock %}

{% block content %}
    <style>

        .swiper-slide {
            text-align: center;
            font-size: 18px;
        {#background: #fff;#} display: flex;
            justify-content: center;
            align-items: center;
        }

        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>

    <div class="row justify-content-center">
        <div class="col-md-10 col-sm-12">
            <div class="row info-panel layout justify-content-center" id="info-card">
                <div class="col-md-3 col-sm-8 info-card avatar justify-content-center">
                    <img src="{{ member.image_link }}" class="img-responsive" loading="lazy"
                         style="max-height: 260px;"/>
                    <h3>{{ member.name }}</h3>
                    <em>{{ member.english_name }}</em>
                </div>
                <div class="col-md-4 col-sm-8 info-card justify-content-center">
                    <h2>æˆå‘˜å®åŠ›</h2>
                    {% if ability %}
                        <div id="ability-charts" style="display: block;padding: 10px 20px;height: 300px;">

                        </div>
                    {% endif %}
                </div>
                <div class="col-md-3 col-sm-8 info-card detail justify-content-center">
                    <!--        <div class="row" style="margin-bottom:10px">-->
                    <!--            <h4>{{ member }}</h4>-->
                    <!--        </div>-->
                    <h2>æˆå‘˜ä¿¡æ¯</h2>
                    <p style="line-height: 28px">
                        {#                        <div class="col-md-6">#}
                        {#                            <p>æ˜µç§°: {{ member.nick_name }}</p>#}
                        èº«é«˜: {{ member.height }}<br/>
                        {#                            <p>è¡€å‹: {{ member.blood_type }}</p><br/>#}
                        ç”Ÿæ—¥: {{ member.birthday }}<br/>
                        {#                            <p>æ˜Ÿåº§: {{ member.constellation }}</p><br/>#}
                        å‡ºç”Ÿåœ°: {{ member.birth_place }} <br/>
                        åŠ å…¥æ—¶é—´: {{ member.join_time }} <br/>
                        åŠ å…¥æ‰€å±: {{ member.batch }}<br/>
                        {#                        </div>#}
                        {#                        <div class="col-md-6">#}
                        {#                            <p>ä¸ªäººç‰¹é•¿: {{ member.speciality }}</p><br/>#}
                        {#                            <p>å…´è¶£çˆ±å¥½: {{ member.hobby }}</p><br/>#}
                        {#                            <p>åŠ å…¥æ—¶é—´: {{ member.join_time }}</p><br/>#}
                        {#                            <p>åŠ å…¥æ‰€å±: {{ member.batch }}</p><br/>#}
                        {#                            <p>æ‰€å±å…¬å¸: {{ member.agency }}</p><br/>#}
                        {#                        </div>#}
                </div>

                {#                    <div class="row">#}
                {#                        <div class="col-md-12">#}
                {#                            <p>ç»å†å¤‡æ³¨: {{ member.description | linebreaks }}</p>#}
                {#                        </div>#}
                {#                    </div>#}
            </div>
        </div>
    </div>
    {% if transfer_details %}
        <div class="row justify-content-center" style="margin-top:10px">
            <div class="col-md-10 col-sm-12">
                <h3>æˆå‘˜ç»å†</h3>
            </div>
        </div>
        <div class="row justify-content-center" style="margin-top:10px;margin-bottom:10px">
            <div class="col-md-10 col-sm-12">
                <div id="sliderContainer" class="swiper mySwiper">
                    <div class="swiper-wrapper">
                        {% for detail in transfer_details %}
                            <div class="swiper-slide">
                                <div class="content">
                                    <p style="font-size: 32px">
                                        {% if detail.type == 1 %}
                                            ğŸ†•
                                        {% elif detail.type == 2 %}
                                            â¡ï¸
                                        {% elif detail.type == 3 %}
                                            â¬‡ï¸
                                        {% elif detail.type == 4 %}
                                            â¬†ï¸
                                        {% elif detail.type == 5 %}
                                            ğŸ”€
                                        {% elif detail.type == 6 %}
                                            ğŸ”‚
                                        {% elif detail.type == 7 %}
                                            ğŸ”š
                                        {% elif detail.type == 8 %}
                                            ğŸ”™
                                        {% elif detail.type == 9 %}
                                            ğŸ…
                                        {% elif detail.type == 10 %}
                                            ğŸ†
                                        {% endif %}
                                    </p>
                                    <p>{{ detail.date }}</p>
                                    <p>{{ detail.description }}</p>
                                </div>

                            </div>
                        {% endfor %}
                    </div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>
        </div>
    {% endif %}
    <div class="row justify-content-center" style="margin-top:10px">
        <div class="col-md-10">
            <ul class="nav nav-pills mb-3" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="p-performance-tab" data-bs-toggle="pill" href="#p-performance"
                       role="tab" aria-controls="p-performance" aria-selected="true">å…¬æ¼”æ¦‚å†µ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="p-member-tab" data-bs-toggle="pill" href="#p-member"
                       role="tab" aria-controls="p-member" aria-selected="true">å…¬æ¼”è¯¦æƒ…</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="p-unit-tab" data-bs-toggle="pill" href="#p-unit"
                       role="tab" aria-controls="p-unit" aria-selected="false">Unit</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="p-weibo-tab" data-bs-toggle="pill" href="#p-weibo"
                       role="tab" aria-controls="p-weibo" aria-selected="false">å¾®åš</a>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="p-performance" role="tabpanel"
                     aria-labelledby="p-performance-tab">
                    {% if performance_num_by_year_list %}
                        <h3>æŒ‰å¹´ä»½ç»Ÿè®¡</h3>
                        <table class="display table table-hover" data-toggle="table"
                               data-pagination="true"
                               data-page-list="[10, 20, 50, 100]"
                               data-mobile-responsive="true"
                               data-page-size=20
                               data-striped="true">
                            <thead>
                            <tr class="text-center">
                                <th>å¹´ä»½</th>
                                <th>å…¬æ¼”åœºæ¬¡</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for ph in performance_num_by_year_list %}
                                <tr class="text-center">
                                    <td>{{ ph.year }}</td>
                                    <td>{{ ph.count }}</td>
                                </tr>
                            {% endfor %}
                            <tr class="text-center">
                                <td><b>æ€»è®¡</b></td>
                                <td>{{ total_performance_num }}</td>
                            </tr>
                            </tbody>
                        </table>
                    {% endif %}

                    {% if performance_num_by_team_list %}
                        <h3>æŒ‰é˜Ÿä¼ç»Ÿè®¡</h3>
                        <table class="display table table-hover" data-toggle="table"
                               data-pagination="true"
                               data-page-list="[10, 20, 50, 100]"
                               data-mobile-responsive="true"
                               data-page-size=20
                               data-striped="true">
                            <thead>
                            <tr class="text-center">
                                <th>é˜Ÿä¼</th>
                                <th>å…¬æ¼”åœºæ¬¡</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for ph in performance_num_by_team_list %}
                                <tr class="text-center">
                                    <td>{{ ph.team_name }}</td>
                                    <td>{{ ph.count }}</td>
                                </tr>
                            {% endfor %}
                            <tr class="text-center">
                                <td><b>æ€»è®¡</b></td>
                                <td>{{ total_performance_num }}</td>
                            </tr>
                            </tbody>
                        </table>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="p-member" role="tabpanel"
                     aria-labelledby="p-member-tab">
                    {% if mph_list %}
                        <table class="display table table-hover" data-toggle="table"
                               data-pagination="true"
                               data-page-list="[10, 20, 50, 100]"
                               data-mobile-responsive="true"
                               data-page-size=20
                               data-striped="true">
                            <thead>
                            <tr class="text-center">
                                <th>å…¬æ¼”</th>
                                <th>é˜Ÿä¼</th>
                                <th>æ—¥æœŸ</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for ph in mph_list %}
                                <tr class="text-center">
                                    <td>{{ ph.performance }}</td>
                                    <td>{{ ph.team }}</td>
                                    <td>{{ ph.date }}</td>
                                    <td>{{ ph.description }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="alert alert-info">æš‚æ— å…¬æ¼”è®°å½•ï¼Œæ•¬è¯·æœŸå¾…</div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="p-unit" role="tabpanel" aria-labelledby="p-unit-tab">
                    {% if unit_list %}
                        <table class="display table table-hover" data-toggle="table"
                               data-pagination="true"
                               data-page-list="[10, 20, 50, 100]"
                               data-mobile-responsive="true"
                               data-page-size=20
                               data-striped="true">
                            <thead>
                            <tr class="text-center">
                                <th>æ—¥æœŸ</th>
                                <th>Unit</th>
                                <th>é¡ºä½</th>
                                <th>å…¬æ¼”</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for result in unit_list %}
                                <tr class="text-center">
                                    <td>{{ result.p_date }}</td>
                                    <td>{{ result.unit_name }}</td>
                                    <td>{{ result.unit_rank }}</td>
                                    <td>{{ result.name }}</td>
                                    <td>{{ result.description }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="alert alert-info">æš‚æ— Unitæ›²çš„è¡¨æ¼”è®°å½•</div>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="p-weibo" role="tabpanel"
                     aria-labelledby="p-weibo-tab">
                    <div class="row">
                        <div class="col-8"></div>
                        <div class="col-2">
                            <div class="d-flex justify-content-end">
                                <select id="timeRange" class="form-control">
                                    <option value="all">æ‰€æœ‰æ—¶é—´</option>
                                    <option value="1m">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
                                    <option value="3m">æœ€è¿‘ä¸‰ä¸ªæœˆ</option>
                                    <option value="6m">æœ€è¿‘åŠå¹´</option>
                                    <option value="1y">æœ€è¿‘ä¸€å¹´</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-2"></div>
                    </div>
                    <div class="row justify-content-center" style="margin-top:10px">
                        <div class="col-md-10 col-sm-12">
                            <div id="fansChart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {% if transfer_details %}
        <script>
            const swiper = new Swiper('#sliderContainer', {
                slidesPerView: window.innerWidth < 768 ? 2 : 4,
                breakpoints: {
                    640: { slidesPerView: 2 },
                    1024: { slidesPerView: 4 }
                },
                spaceBetween: 20,
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                navigation: {
                    nextEl: ".swiper-button-next",
                    prevEl: ".swiper-button-prev",
                },
            });
        </script>
    {% endif %}

    {% if weibo_fans_data %}
        <script>
            $('a[data-bs-toggle="pill"]').on('shown.bs.tab', function (e) {
                // è·å–å½“å‰é€‰é¡¹å¡çš„ç›®æ ‡é¢æ¿çš„ ID
                const targetPanelId = $(e.target).attr('href');

                // æ‰¾åˆ°ç›®æ ‡é¢æ¿å†…çš„ ECharts å®¹å™¨
                const chartContainer = $(targetPanelId).find('#fansChart');

                // è·å–è¯¥å®¹å™¨çš„å®½åº¦å’Œé«˜åº¦
                const containerWidth = chartContainer.width();
                const containerHeight = chartContainer.height();

                // é€šè¿‡ ECharts å®ä¾‹çš„ resize() æ–¹æ³•é‡æ–°æ¸²æŸ“å›¾è¡¨
                const chartInstance = echarts.getInstanceByDom(chartContainer[0]);
                chartInstance.resize({
                    width: containerWidth,
                    height: containerHeight
                });
            });

            const fansData = {{ weibo_fans_data|safe }};
            const chartDom = $('#fansChart')[0];
            const myChart = echarts.init(chartDom);

            // åˆ›å»ºæ•°æ®é›†
            const dates = fansData.map(d => d.date);
            const counts = fansData.map(d => d.count);

            // é…ç½®å›¾è¡¨é€‰é¡¹
            const option = {
                title: {
                    text: 'å¾®åšç²‰ä¸æ•°å˜åŒ–è¶‹åŠ¿',
                    left: 'center', // æ ‡é¢˜çš„æ°´å¹³å¯¹é½æ–¹å¼ï¼Œå¯é€‰å€¼æœ‰ 'left'ã€'center' æˆ– 'right'
                    top: 'top', // æ ‡é¢˜çš„å‚ç›´å¯¹é½æ–¹å¼ï¼Œå¯é€‰å€¼æœ‰ 'top'ã€'middle' æˆ– 'bottom'
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold',
                        color: '#333'
                    }
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    min: 'dataMin', // æ ¹æ®æ•°æ®è‡ªåŠ¨é€‰æ‹©æœ€å°å€¼
                },
                series: [{
                    data: counts,
                    type: 'line',
                    smooth: true
                }],
                tooltip: {
                    trigger: 'axis'
                }
            };

            // è®¾ç½®å›¾è¡¨é€‰é¡¹
            myChart.setOption(option);
            const timeRangeSelect = $('#timeRange');

            // è·å–æ—¥æœŸèŒƒå›´
            function filterDataByDateRange(data, dateRange) {
                const endDate = new Date();
                const startDate = new Date(endDate);

                switch (dateRange) {
                    case '1m':
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case '3m':
                        startDate.setMonth(startDate.getMonth() - 3);
                        break;
                    case '6m':
                        startDate.setMonth(startDate.getMonth() - 6);
                        break;
                    case '1y':
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        break;
                    default:
                        return data;
                }

                return data.filter(function (item) {
                    const itemDate = new Date(item.date);
                    return itemDate >= startDate && itemDate <= endDate;
                });
            }

            // æ›´æ–°å›¾è¡¨
            function updateChart(data) {
                const dates = data.map(function (item) {
                    return item.date;
                });
                const counts = data.map(function (item) {
                    return item.count;
                });

                option.xAxis.data = dates;
                option.series[0].data = counts;

                myChart.setOption(option);
            }

            // ä¸ºtimeRangeä¸‹æ‹‰èœå•æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            timeRangeSelect.on('change', () => {
                const range = timeRangeSelect.val();
                const filteredData = filterDataByDateRange(fansData, range);
                updateChart(filteredData);
            });

            // åˆå§‹åŒ–å›¾è¡¨
            updateChart(fansData);

        </script>
    {% endif %}
    {% if ability %}
        <script>
            let radar_chart = echarts.init(document.getElementById('ability-charts'));
            let option2 = {
                /*
                title: {
                    text: 'ä¸ªäººå®åŠ›'
                },*/
                radar: {
                    name: {
                        textStyle: {
                            color: '#fff',
                            backgroundColor: '#999',
                            borderRadius: 3,
                            padding: [3, 5]
                        }
                    },
                    indicator: [
                        {name: 'å”±æ­Œ', max: 99},
                        {name: 'èˆè¹ˆ', max: 99},
                        {name: 'MC', max: 99},
                        {name: 'æ¼”æŠ€', max: 99},
                        {name: 'å¥åº·', max: 99},
                        {name: 'æŠ•å…¥åº¦', max: 99},
                        {name: 'é¢†å¯¼åŠ›', max: 99},
                        {name: 'æŠ—å‹èƒ½åŠ›', max: 99}
                    ]
                },
                series: [
                    {
                        // name: 'èƒ½åŠ›å±•ç°',
                        type: 'radar',
                        // areaStyle: {normal: {}},
                        label: {
                            show: true,
                            formatter: function (params) {
                                return params.value;
                            }
                        },
                        data: [
                            {
                                value: [{{ ability.sing }}, {{ ability.dance }}, {{ ability.variety }},
                                    {{ ability.act }}, {{ ability.health }}, {{ ability.concentration }},
                                    {{ ability.leadership }}, {{ ability.pressure }}],
                                name: 'èƒ½åŠ›',
                                areaStyle: {
                                    opacity: 0.9,
                                    color: new echarts.graphic.RadialGradient(0.5, 0.5, 1, [
                                        {
                                            color: '#B8D3E4',
                                            offset: 0
                                        },
                                        {
                                            color: '#72ACD1',
                                            offset: 1
                                        }
                                    ])
                                }
                            }
                        ]
                    }
                ]
            };
            radar_chart.setOption(option2);
        </script>
    {% endif %}
{% endblock %}